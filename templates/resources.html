{% extends "base.html" %}

{% block title %}Therapy Resources{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Therapy Resources</h2>
            <p class="text-muted mb-0">Educational materials, activities, and tools for autism therapy</p>
        </div>
        <div>
            {% if current_user.role in ['therapist', 'admin'] %}
            <a href="{{ url_for('upload_resource') }}" class="btn btn-primary">
                <i class="fas fa-upload me-1"></i> Upload Resource
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Search Resources</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="search" name="search" 
                            placeholder="Search by title, description, or tags..." 
                            value="{{ request.args.get('search', '') }}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" name="category">
                        <option value="">All Categories</option>
                        <option value="worksheets" {% if request.args.get('category') == 'worksheets' %}selected{% endif %}>Worksheets</option>
                        <option value="videos" {% if request.args.get('category') == 'videos' %}selected{% endif %}>Videos</option>
                        <option value="games" {% if request.args.get('category') == 'games' %}selected{% endif %}>Games</option>
                        <option value="guides" {% if request.args.get('category') == 'guides' %}selected{% endif %}>Guides</option>
                        <option value="assessments" {% if request.args.get('category') == 'assessments' %}selected{% endif %}>Assessments</option>
                        <option value="tools" {% if request.args.get('category') == 'tools' %}selected{% endif %}>Tools</option>
                        <option value="books" {% if request.args.get('category') == 'books' %}selected{% endif %}>Books</option>
                        <option value="other" {% if request.args.get('category') == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="age_group" class="form-label">Age Group</label>
                    <select class="form-select" id="age_group" name="age_group">
                        <option value="">All Ages</option>
                        <option value="2-4" {% if request.args.get('age_group') == '2-4' %}selected{% endif %}>2-4 years</option>
                        <option value="5-7" {% if request.args.get('age_group') == '5-7' %}selected{% endif %}>5-7 years</option>
                        <option value="8-12" {% if request.args.get('age_group') == '8-12' %}selected{% endif %}>8-12 years</option>
                        <option value="13-17" {% if request.args.get('age_group') == '13-17' %}selected{% endif %}>13-17 years</option>
                        <option value="18+" {% if request.args.get('age_group') == '18+' %}selected{% endif %}>18+ years</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="difficulty" class="form-label">Difficulty</label>
                    <select class="form-select" id="difficulty" name="difficulty">
                        <option value="">All Levels</option>
                        <option value="beginner" {% if request.args.get('difficulty') == 'beginner' %}selected{% endif %}>Beginner</option>
                        <option value="intermediate" {% if request.args.get('difficulty') == 'intermediate' %}selected{% endif %}>Intermediate</option>
                        <option value="advanced" {% if request.args.get('difficulty') == 'advanced' %}selected{% endif %}>Advanced</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">Filter</button>
                    <a href="{{ url_for('resources') }}" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Resource Categories Quick Links -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="category-tabs">
                <a href="{{ url_for('resources', category='worksheets') }}" 
                   class="btn btn-outline-primary me-2 mb-2 {% if request.args.get('category') == 'worksheets' %}active{% endif %}">
                    <i class="fas fa-file-alt me-1"></i> Worksheets
                </a>
                <a href="{{ url_for('resources', category='videos') }}" 
                   class="btn btn-outline-primary me-2 mb-2 {% if request.args.get('category') == 'videos' %}active{% endif %}">
                    <i class="fas fa-video me-1"></i> Videos
                </a>
                <a href="{{ url_for('resources', category='games') }}" 
                   class="btn btn-outline-primary me-2 mb-2 {% if request.args.get('category') == 'games' %}active{% endif %}">
                    <i class="fas fa-gamepad me-1"></i> Games
                </a>
                <a href="{{ url_for('resources', category='guides') }}" 
                   class="btn btn-outline-primary me-2 mb-2 {% if request.args.get('category') == 'guides' %}active{% endif %}">
                    <i class="fas fa-book me-1"></i> Guides
                </a>
                <a href="{{ url_for('resources', category='assessments') }}" 
                   class="btn btn-outline-primary me-2 mb-2 {% if request.args.get('category') == 'assessments' %}active{% endif %}">
                    <i class="fas fa-clipboard-check me-1"></i> Assessments
                </a>
            </div>
        </div>
    </div>

    <!-- Resources Grid -->
    {% if resources %}
    <div class="row">
        {% for resource in resources %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 resource-card">
                <!-- Resource Thumbnail -->
                <div class="card-img-top resource-thumbnail d-flex align-items-center justify-content-center">
                    {% if resource.thumbnail %}
                    <img src="{{ resource.thumbnail }}" alt="{{ resource.title }}" class="img-fluid">
                    {% else %}
                    <div class="resource-icon">
                        {% if resource.category == 'videos' %}
                        <i class="fas fa-video fa-3x text-primary"></i>
                        {% elif resource.category == 'worksheets' %}
                        <i class="fas fa-file-alt fa-3x text-success"></i>
                        {% elif resource.category == 'games' %}
                        <i class="fas fa-gamepad fa-3x text-warning"></i>
                        {% elif resource.category == 'guides' %}
                        <i class="fas fa-book fa-3x text-info"></i>
                        {% elif resource.category == 'assessments' %}
                        <i class="fas fa-clipboard-check fa-3x text-secondary"></i>
                        {% else %}
                        <i class="fas fa-file fa-3x text-muted"></i>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-body d-flex flex-column">
                    <!-- Resource Header -->
                    <div class="mb-2">
                        <h5 class="card-title">{{ resource.title }}</h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">{{ resource.category.title() }}</span>
                            <div class="resource-rating">
                                {% for i in range(1, 6) %}
                                    {% if i <= (resource.average_rating or 0) %}
                                        <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                        <i class="far fa-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                                <small class="text-muted">({{ resource.rating_count or 0 }})</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resource Details -->
                    <p class="card-text flex-grow-1">{{ resource.description[:100] }}{% if resource.description|length > 100 %}...{% endif %}</p>
                    
                    <!-- Resource Meta -->
                    <div class="resource-meta mb-3">
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i> {{ resource.age_group or 'All ages' }}
                            <i class="fas fa-signal ms-2 me-1"></i> {{ resource.difficulty.title() if resource.difficulty else 'Any level' }}
                        </small>
                        {% if resource.tags %}
                        <div class="mt-2">
                            {% for tag in resource.tags.split(',')[:3] %}
                            <span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-auto">
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('view_resource', id=resource.id) }}" class="btn btn-primary">
                                <i class="fas fa-eye me-1"></i> View
                            </a>
                            {% if resource.file_path %}
                            <a href="{{ url_for('download_resource', id=resource.id) }}" class="btn btn-outline-primary">
                                <i class="fas fa-download me-1"></i> Download
                            </a>
                            {% endif %}
                            <button type="button" class="btn btn-outline-secondary" 
                                onclick="toggleFavorite({{ resource.id }})" 
                                id="favorite-btn-{{ resource.id }}">
                                <i class="{% if resource.is_favorite %}fas{% else %}far{% endif %} fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Resource Footer -->
                <div class="card-footer text-muted">
                    <small>
                        Uploaded by {{ resource.uploaded_by }} • {{ resource.upload_date.strftime('%Y-%m-%d') }}
                        <span class="float-end">
                            <i class="fas fa-download me-1"></i> {{ resource.download_count or 0 }}
                        </span>
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pagination %}
    <nav aria-label="Resources pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('resources', page=pagination.prev_num, **request.args) }}">Previous</a>
            </li>
            {% endif %}
            
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num != pagination.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('resources', page=page_num, **request.args) }}">{{ page_num }}</a>
                    </li>
                    {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% endif %}
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('resources', page=pagination.next_num, **request.args) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- No Resources Found -->
    <div class="text-center py-5">
        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Resources Found</h5>
        <p class="text-muted">
            {% if request.args.get('search') or request.args.get('category') %}
            Try adjusting your search criteria or browse all resources.
            {% else %}
            Be the first to upload resources for the therapy platform.
            {% endif %}
        </p>
        {% if current_user.role in ['therapist', 'admin'] %}
        <a href="{{ url_for('upload_resource') }}" class="btn btn-primary">
            <i class="fas fa-upload me-1"></i> Upload First Resource
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function toggleFavorite(resourceId) {
    fetch(`/api/resources/${resourceId}/favorite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById(`favorite-btn-${resourceId}`);
            const icon = btn.querySelector('i');
            if (data.is_favorite) {
                icon.className = 'fas fa-heart';
            } else {
                icon.className = 'far fa-heart';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>

<style>
.resource-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.resource-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.resource-thumbnail {
    height: 200px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.resource-thumbnail img {
    max-height: 100%;
    max-width: 100%;
    object-fit: cover;
}

.resource-icon {
    text-align: center;
}

.category-tabs .btn.active {
    background-color: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.resource-rating {
    font-size: 0.9rem;
}

.resource-meta {
    font-size: 0.85rem;
}
</style>
{% endblock %}